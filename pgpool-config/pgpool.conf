#------------------------------------------------------------------------------
# PGPOOL-II CONFIGURATION FILE for PostgreSQL Streaming Replication Demo
#------------------------------------------------------------------------------
# This config demonstrates:
# - Automatic query routing (SELECT → standbys, INSERT/UPDATE/DELETE → primary)
# - Load balancing across multiple standbys (STANDBY1 and STANDBY2)
# - Connection pooling
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
# CONNECTIONS
#------------------------------------------------------------------------------

# Listen on all interfaces
listen_addresses = '*'
port = 9999

# Socket directory
socket_dir = '/var/run/pgpool'

# PID file location
pid_file_name = '/var/run/pgpool/pgpool.pid'
logdir = '/var/log/pgpool'

# Reserved connections for superuser
reserved_connections = 1

#------------------------------------------------------------------------------
# BACKEND CONNECTIONS
#------------------------------------------------------------------------------

# Backend 0: PRIMARY (Read/Write)
backend_hostname0 = 'postgres-primary'
backend_port0 = 5432
backend_weight0 = 0
backend_data_directory0 = '/var/lib/postgresql/data'
backend_flag0 = 'DISALLOW_TO_FAILOVER'
backend_application_name0 = 'primary'

# Backend 1: STANDBY1 (Read-Only)
backend_hostname1 = 'postgres-standby'
backend_port1 = 5432
backend_weight1 = 1
backend_data_directory1 = '/var/lib/postgresql/data'
backend_flag1 = 'DISALLOW_TO_FAILOVER'
backend_application_name1 = 'standby1'

# Backend 2: STANDBY2 (Read-Only)
backend_hostname2 = 'postgres-standby2'
backend_port2 = 5432
backend_weight2 = 1
backend_data_directory2 = '/var/lib/postgresql/data'
backend_flag2 = 'DISALLOW_TO_FAILOVER'
backend_application_name2 = 'standby2'

#------------------------------------------------------------------------------
# AUTHENTICATION
#------------------------------------------------------------------------------

enable_pool_hba = on
pool_passwd = 'pool_passwd'
authentication_timeout = 60
allow_clear_text_frontend_auth = on

#------------------------------------------------------------------------------
# CONNECTION POOLING (Reduced for macOS shared memory limits)
#------------------------------------------------------------------------------

num_init_children = 8
max_pool = 2
child_life_time = 300
child_max_connections = 0
connection_life_time = 0
client_idle_limit = 0

#------------------------------------------------------------------------------
# LOAD BALANCING
#------------------------------------------------------------------------------

# Enable load balancing for SELECT queries
load_balance_mode = on

# Ignore leading white spaces for load balancing
ignore_leading_white_space = on

# Read queries sent to primary can be load balanced
read_only_function_list = ''
write_function_list = ''

# Disable certain statements from load balancing (empty for demo)
black_function_list = ''
black_query_pattern_list = ''

# Database regex and user regex for load balancing
database_redirect_preference_list = ''
app_name_redirect_preference_list = ''
allow_sql_comments = on

# Disable statement level load balancing (set to 'off' for demo to see load balancing in action)
disable_load_balance_on_write = 'off'

#------------------------------------------------------------------------------
# REPLICATION MODE (Streaming Replication)
#------------------------------------------------------------------------------

# Streaming replication mode
backend_clustering_mode = 'streaming_replication'

# Enable streaming replication delay check
sr_check_period = 10
sr_check_user = 'postgres'
sr_check_password = 'postgres_password'
sr_check_database = 'postgres'
delay_threshold = 10000000

# Follow primary for certain queries
follow_primary_command = ''

#------------------------------------------------------------------------------
# HEALTH CHECK
#------------------------------------------------------------------------------

health_check_period = 10
health_check_timeout = 20
health_check_user = 'postgres'
health_check_password = 'postgres_password'
health_check_database = 'postgres'
health_check_max_retries = 3
health_check_retry_delay = 1
connect_timeout = 10000

#------------------------------------------------------------------------------
# FAILOVER AND FAILBACK
#------------------------------------------------------------------------------

# Disable automatic failover (manual demo only)
failover_on_backend_error = off
failover_command = ''
failback_command = ''
failover_on_backend_shutdown = off
detach_false_primary = off

#------------------------------------------------------------------------------
# ONLINE RECOVERY
#------------------------------------------------------------------------------

recovery_user = 'postgres'
recovery_password = ''
recovery_1st_stage_command = ''
recovery_2nd_stage_command = ''
recovery_timeout = 90

#------------------------------------------------------------------------------
# WATCHDOG (Disabled for single-instance demo)
#------------------------------------------------------------------------------

use_watchdog = off

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------

log_destination = 'stderr'
log_line_prefix = '%t: pid %p: '
log_connections = on
log_disconnections = on
log_hostname = on
log_statement = on
log_per_node_statement = on
log_client_messages = on
log_standby_delay = 'always'

# Error reporting
client_min_messages = notice
log_min_messages = info

#------------------------------------------------------------------------------
# QUERY CACHE (Disabled)
#------------------------------------------------------------------------------

memory_cache_enabled = off
memqcache_total_size = 8MB
memqcache_max_num_cache = 100000
memqcache_expire = 0
memqcache_auto_cache_invalidation = on
memqcache_maxcache = 100kB

#------------------------------------------------------------------------------
# IN MEMORY QUERY CACHE (Disabled)
#------------------------------------------------------------------------------

enable_shared_relcache = off

#------------------------------------------------------------------------------
# CONNECTION SETTINGS
#------------------------------------------------------------------------------

reset_query_list = 'ABORT; DISCARD ALL'

#------------------------------------------------------------------------------
# PCP (Pgpool Control Protocol)
#------------------------------------------------------------------------------

pcp_listen_addresses = '*'
pcp_port = 9898
pcp_socket_dir = '/var/run/pgpool'

#------------------------------------------------------------------------------
# SSL (Disabled for demo)
#------------------------------------------------------------------------------

ssl = off

#------------------------------------------------------------------------------
# LOAD BALANCING WEIGHTS EXPLAINED
#------------------------------------------------------------------------------
# backend_weight0 = 0  → PRIMARY gets NO SELECT queries (writes only)
# backend_weight1 = 1  → STANDBY1 gets 50% of SELECT queries
# backend_weight2 = 1  → STANDBY2 gets 50% of SELECT queries
#
# Total weight = 0 + 1 + 1 = 2
# STANDBY1 share = 1/2 = 50%
# STANDBY2 share = 1/2 = 50%
#------------------------------------------------------------------------------
